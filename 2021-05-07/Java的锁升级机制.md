## 简述 Java 锁升级的机制
Java锁升级指使用synchronized加锁时，锁会根据竞争的激烈程度使用不同的策略，激烈程度上升，锁也会从偏向锁升级到轻量级锁，重量级锁。

- 偏向锁：如果一个线程在没有竞争的时候申请锁，首先开启偏向模式，对象头Mark Word的锁偏向位设置为1，锁标志位”01“，并且记录当前获得锁的线程id。一旦有其他线程申请这把锁时，偏向模式结束，开始升级到轻量级锁。
- 轻量级锁：偏向模式结束后（偏向位置为0），申请锁的线程会在栈中的锁记录（Lock Record）中存锁对象Mark Word的拷贝，然后JVM通过CAS操作把对象的Mark Word更新为指向获得锁的线程的Lock Record中的拷贝。标志位置为”00“。
- 如果持有锁之外的线程去申请轻量级锁，轻量级锁会升级到重量级锁，标志位置为”10“。

功能：

- 偏向锁可以提高带有同步但无竞争的程序性能，但它也是带有权益平衡的（Trade Off）性质的优化。**如果程序中大多数锁都被不同的线程访问，那禁用偏向锁优化（-XX:UseBiasedLocking）反而能提高性能**。
- 轻量级锁能提高性能的依据是”对于大部分的锁。在整个同步周期内都不存在竞争“这一经验法则。如果没有竞争，轻量级锁通过CAS操作成功避免了使用互斥量的开销；如果确实存在竞争，除了互斥量的开销，还额外发生了CAS操作的开销。也就是说**有竞争的情况下，轻量级锁反而比重量级锁更慢**。