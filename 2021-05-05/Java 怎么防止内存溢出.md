
## Java 怎么防止内存溢出
### 合理设置和使用JVM

- 评估业务场景和服务器资源，设置合适的JVM堆（-Xms，-Xmx）和方法区（-XX:MaxPermSize，JDK8及以上为-XX:MaxMetaspaceSize）的大小；
- 避免设置过大的栈容量(-Xss)，操作系统给每个进程分配的内存是有限制的。JVM可以通过参数控制堆和方法区的最大值，程序计数器消耗内存很小，可以忽略，剩余的容量基本由虚拟机栈和本地方法栈分配。每个线程分配到的内存越大，可以创建的线程就越少，创建线程时越容易耗尽内存。
- 尽量升级到JDK7以上的版本，JDK6及以下版本的字符串常量池还在方法区中，大小受-XX:MaxPermSize限制（通常不大），之后的版本，字符串常量池转移到了堆，减少了溢出风险。高版本JDK带来的另一个好处是类的元数据（类名、访问修饰符、字段描述、方法描述等）转移到了元空间。一个类要被垃圾回收的条件是比较苛刻的，Spring、Hibernate等框架对类使用CGLIB等技术进行增强，会在运行时生成大量动态类，方法区太小的话就很容易溢出。
- 谨慎使用直接内存（Native Memory），直接内存不受JVM的垃圾回收机制管理，使用完之后需要手动释放。


### 养成良好的编程习惯

- 避免多余的对象创建，比如在循环内创建对象等。
- 合理使用单例模式和对象池化技术，提高对象复用率；
- 没必要的情况下，尽量少用静态变量，常量等会被JVM视为GC Root的对象；
- 谨慎使用递归和循环，避免死循环（堆溢出）和过深的递归链（栈溢出），也要避免在循环或递归过程中执行内存消耗过大的操作；
- 尽早释放不用的对象，置为null提示JVM进行回收；