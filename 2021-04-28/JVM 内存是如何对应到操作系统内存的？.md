## JVM 内存是如何对应到操作系统内存的？

### 操作系统的内存模型
进程的地址空间，也叫虚拟地址空间和逻辑地址空间，指的是这个进程所有虚拟地址的集合。地址空间大小取决于操作系统的位数，即CPU的数据处理能力。如果是32位操作系统，那么地址空间的寻址范围就是0 ~ 2^32-1。

物理内存资源有限，不可能将虚拟内存空间全部放到物理内存，如需要加载虚拟地址空间到物理内存，需要用页表，按需调页。页表是进程维护的记录虚拟地址空间和物理页映射的一张表。程序运行时，会根据页表判断这个地址所在的虚拟页是否有物理页，如果有则直接读取对应地址的数据，如果没有需要先寻找一物理块页存储虚拟页，然后构建映射关系。

操作系统的用户空间，主要分为代码段(.text)、数据段(.data)、bss段(.bss)、内存映射区、堆、栈。

- 代码段：主要存放当前进程源代码编译后的机器指令或一些常量；
- 数据段：主要用来存放已经初始化的静态变量和全局变量；
- bss段：主要存放未初始化的静态变量和全局变量；
- 内存映射区域：内存映射的时候，会在虚拟地址空间寻找一段连续的空间和文件进行映射，这段空间的就是内存映射区域。
- 栈：主要存放函数调用过程中的参数、局部变量和函数的返回值，操作系统管理，自动分配和回收；
- 堆：主要存放new或malloc动态分配的内存，一般由程序员分配和释放。（没释放就内存泄漏）

JVM对于操作系统而言，就是一个程序，JVM本身也是基于C++来写的，所以JVM本身的内存结构就是C/C++的内存模型。但是内存区域并不是一一对应的。

JVM堆、栈、方法区（JDK8以后的元空间）都属于操作系统（用户空间）的堆上的内存区域。

- 堆：基于操作系统的堆实现，唯一区别是C++的内存由程序员分配和释放，JVM有自己的GC机制管理；
- 栈：操作系统的栈是系统自动管理的，随时可能被回收，这样一来对于JVM来说，对象什么时候回收就变得不可控了；
- 方法区：操作系统运行进程的时候，会从磁盘加载目标文件到内存，JVM也有一块这样的区域，方法区。class字节码被JVM加载后就存放在方法区里。JDK1.8之后使用元空间（Meta Space）代理，不再使用JVM内存，而是使用直接内存，方法区的字符串常量池移到了堆中；
- 程序计数器：和进程的程序计数器相似，指向下一条要执行的指令。