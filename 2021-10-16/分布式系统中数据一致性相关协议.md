### 分布式系统中数据一致性相关协议

常见的用来保证数据一致性的协议有：2PC、3PC、Paxos、raft

### 2PC
两阶段提交协议设计目的为了保证分布式事务的原子性。节点分为协调者和参与者，操作分两个阶段：

- 阶段一：协调者确认每个节点是否做好了准备。参与者执行事务操作，锁定资源，并向协调者上报自己的执行结果。
- 阶段二：协调者根据参与者的执行结果提交或回滚事务。如果参与者的本地操作都成功，提交总事务。只要有一个参与者失败了，回滚事务并释放占用的资源。

优点：简单，容易实现。

缺点：

- 同步阻塞：参与者在提交事务前会锁定资源。
- 协调者的单点问题：如第二阶段，协调者宕机会导致参与者一直锁着资源，无法继续事务。
- 数据一致性问题：二阶段协调者发出提交/回滚命令，在发出一部分后宕机了，导致只有部分参与者收到了命令并执行提交/回滚，数据不一致。

### 3PC
3PC 是在 2PC 的阶段上发展而来的协议。区别是：

- 引入了超时机制：在参与者和协调者中都有。
- 预提交：在准备和提交两个阶段之间加了一个阶段：预提交。

改进：

- 相比 2PC，3PC 通过超时机制减少了单点问题（超时后参与者提交/回滚，不再一直锁定资源）。
- 同时，不再一直锁资源也意味着阻塞减少了。

### Paxos
Paxos 算法里节点分三个角色：

- 提议者（Proposer）：负责发起提议（proposal，可理解为数据版本）。
- 投票者（Acceptor）：至少需要一个以上，负责对提议投票。
- 观察者（Learner）：收集被每个投票者接受的提议，并根据多数原则形成“最终提议”。

#### 阶段一：准备阶段

- 提议者：提议者向大多数投票者发送一个版本号为 n 的提议。
- 投票者：如果 n 比投票者之前收到的提议的版本号都大，那么就接受这个提议。否则，拒绝提议并把自己收到的最大版本号发给提议者。

#### 阶段二：投票阶段

- 提议者：提议者收集投票者的响应，如果大多数拒绝，则从响应的版本号中选出最大的，更新自身版本号（下一次提议用）。
- 投票者：每当接受一个提议，就把提议和对应的版本号发给观察者。
- 观察者：记录被每个投票者接受的提议，一个投票者发送多个时取版本号最高。
- 观察者：统计每个提议有多少个投票者支持，出现超过一半支持者时，