### 分布式系统中数据一致性相关协议

常见的用来保证数据一致性的协议有：2PC、3PC、Paxos、Raft。

### 2PC
两阶段提交协议设计目的为了保证分布式事务的原子性。节点分为协调者和参与者，操作分两个阶段：

- 阶段一：协调者确认每个节点是否做好了准备。参与者执行事务操作，锁定资源，并向协调者上报自己的执行结果。
- 阶段二：协调者根据参与者的执行结果提交或回滚事务。如果参与者的本地操作都成功，提交总事务。只要有一个参与者失败了，回滚事务并释放占用的资源。

优点：简单，容易实现。

缺点：

- 同步阻塞：参与者在提交事务前会锁定资源。
- 协调者的单点问题：如第二阶段，协调者宕机会导致参与者一直锁着资源，无法继续事务。
- 数据一致性问题：二阶段协调者发出提交/回滚命令，在发出一部分后宕机了，导致只有部分参与者收到了命令并执行提交/回滚，数据不一致。

### 3PC
3PC 是在 2PC 的阶段上发展而来的协议。区别是：

- 引入了超时机制：在参与者和协调者中都有。
- 预提交：在准备和提交两个阶段之间加了一个阶段：预提交。

改进：

- 相比 2PC，3PC 通过超时机制减少了单点问题（超时后参与者提交/回滚，不再一直锁定资源）。
- 同时，不再一直锁资源也意味着阻塞减少了。

### Paxos
Paxos 算法里节点分三个角色：

- 提议者（Proposer）：负责发起提议（proposal，可理解为数据版本）。
- 投票者（Acceptor）：至少需要一个以上，负责对提议投票。
- 观察者（Learner）：收集被每个投票者接受的提议，并根据多数原则形成“最终提议”。

#### 阶段一：准备阶段

- 提议者：提议者向大多数投票者发送一个版本号为 n 的提议。
- 投票者：如果 n 比投票者之前收到的提议的版本号都大，那么就接受这个提议。否则，拒绝提议并把自己收到的最大版本号发给提议者。

#### 阶段二：投票阶段

- 提议者：提议者收集投票者的响应，如果大多数拒绝，则从响应的版本号中选出最大的，更新自身版本号（下一次提议用）。
- 投票者：每当接受一个提议，就把提议和对应的版本号发给观察者。
- 观察者：记录被每个投票者接受的提议，一个投票者发送多个时取版本号最高。
- 观察者：统计提议有多少个投票者支持，出现超过一半支持者的版本号时，把这个版本号定为数据的“最终版本”。

### Raft
Raft 是一种在 Paxos 基础上衍生而来的算法，比 Paxos 更容易理解，并且多了一些特性。通过状态机让分布式系统里的各个节点，通过一系列状态转移达成一致。**但是，Raft 并不能解决“拜占庭将军问题”**，因为节点都信任被选出来的 Leader。

Raft 算法里，节点可分为 Leader、Follower 和 Candidate。

#### Raft 选举过程

- Follower 在时间阈值内没收到 Leader 的心跳，会转换成 Candidate 并发起一轮选举，带着 term 向其他节点请求投票。
- 如果有多个 Follower 同时成为 Candidate，一种情况是：大家的 term 一样，那么会按照先到先得原则投票，获得票数过半者成为 Leader；另一种情况是：Candidate 会比较自己和收到的 term，如果对方较大，说明自己当前轮选举已经“过时”，承认对方为 Leader 并把自己降为 Follower。
- 如果以上两种情况都没发生，每个节点都把票投给了自己。那么经过一个**随机**的选举超时时间后，节点发起一轮新的选举。随机的超时可以防止多个节点再次同时成为 Candidate。

#### Raft 日志复制
Raft 采用主从架构，Leader 才能接收客户端请求，并负责向 Follower 同步数据。

- 收到客户端请求后，Leader 首先把相关操作写入日志，然后向 Follower 发送相关日志。
- 在收到过半数 Follower 的确认回复后，更新自己的状态机。向客户端响应成功。
- Leader 有可能在以上任意时间点挂掉，导致主从日志不一致。为了处理这个问题，新 Leader 会比较所有 Follower 和自己的日志，比较并找出最新的**被确认过**的日志位置，并把之后产生的日志都删除掉。从而保证所有节点之间的日志一致性。

#### Raft 安全性
Raft 保证以下几点：

- 选举安全：在一个 term 内，最多一个 Leader 被选出来。
- Leader append-only：Leader 只能在日志后面添加，而不能覆盖（更新）或删除日志。
- 状态机安全：如果一个服务器对它的状态机应用了某一条log，那么任何节点，都不能通过向它发送命令来使这条log改变了。

#### 客户端宕机
客户端宕机会导致投票请求和日志同步暂时无法被处理，但是因为有无限重试机制，重启之后这些请求会被处理。

#### 可用性和时间控制
在 Raft 中选举和维持一个稳定的 Leader，时间是很关键的。要让集群完美可用，需要遵循以下大小关系：

`broadcastTime << electionTimeout << MTBF`

- broadcastTime：一个服务器发送请求到另一个服务器并收到响应的平均时间。
- electionTimeout：上面介绍过的选举超时时间。
- MTBF(Mean Time Between Failures) ：服务器发生错误的平均间隔时间