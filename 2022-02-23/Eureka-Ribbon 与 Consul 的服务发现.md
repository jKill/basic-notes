## Eureka-Ribbon 与 Consul 的服务发现
SpringCloud 支持通过 Eureka 构建微服务，而 Eureka 集成了 Ribbon 实现负载均衡（服务发现）。Ribbon 本质上是一个内建的客户端负载均衡，通过不断请求服务端，更新服务状态和信息。

- Eureka 客户端（Ribbon）向服务端注册自己，并拉取全量服务信息（fetchRegistry()方法）。之后每隔30s（可配置）发送一次心跳延长租约（renew lease），并拉取增量服务信息。
- 客户端和服务端互发心跳，Eureka Server 在90s（可配置）内没收到心跳视作服务实例死亡，将其从列表中剔除。

> 严格来说，Ribbon不进行服务发现，但由于Netflix组件的松散耦合，Ribbon需要执行与Eureka缓存服务列表上的“服务发现”类似的行为，以便构建自己的负载平衡列表并及时更新.
 
### Eureka 和 Consul 的集群状态同步
#### Eureka 的集群状态同步
Eureka 提供了弱一致性的状态复制，客户端向任意服务端节点更新成功后，异步向其他服务端节点发送更新（类似于 gossip 协议，服务端节点之间会互相同步）。

- 弱一致性：服务注册到某一个 Eureka 服务端节点后，这个节点会尝试复制这个状态更新到其他服务端节点，但不保证送达。
- 但是客户端请求可以路由到任意节点，其中总有一个包含完整的数据。
- 这个简化的模型的优点是提供更容易的集群管理，和高可拓展性。

#### Consul 的集群状态同步
与 Eureka 大大不同，Consul 基于 Raft 算法提供了强一致性的状态复制。并且健康检测方式也不仅仅限于超时，还支持 HTTP、TCP、Nagios/Sensu 脚本。

- 请求发现总是路由到 Leader：保证强一致性。
- 客户端参与健康检查：基于 gossip 协议，客户端也加入健康检查，可以避免集中式的心跳那样变成可拓展性的瓶颈。
- 集成了 DNS 到健康检查：如果检查到某个节点失效，DNS 接口将在服务查询中忽略该节点。

### 服务端节点重启或新节点加入后的状态初始化
一个新的 Eureka 节点加入，或者 Eureka Server 重启后，把自己当做 Consumer 从其他服务端节点拉取所有服务的注册信息。