### RDB和AOF的工作流程
RDB和AOF简介：

- RDB(Redis Database)会定期地对数据集做一个实时快照。
- AOF(Append Only File)持久化日志以append-only的方式记录redis server收到的写操作，在server启动的时候，会被用来重建数据集。在AOF文件过大的时候，会在后台进行AOF重写(rewrite)操作，减小文件体积。

RDB如何工作：

- ```SAVE```后者```BGSAVE```命令后，Redis会forks一个子进程。
- 子进程把数据集写到临时的RDB文件。
- 使用这个新的RDB文件替换原来的RDB文件。

AOF如何工作

- 配置```appendonly yes```后，Redis将改变数据集的命令写到AOF文件
- 如果重启，AOF文件会重放，构建数据集

### RDB和AOF应该如何选择
Redis官方文档推荐两种都用。

- 只用RDB：如果你的系统能容忍意外宕机时，有几分钟的数据丢失，可以只用RDB。
- 只用AOF：同样不推荐，RDB快照有利于系统的快速重启，而且在AOF引擎故障的时候，还能作为AOF的备胎。

> 考虑到以上原因，Redis未来可能会把RDB和AOF统一到一个持久化模型里去。

### AOF和RDB的交互
如果同时开启了AOF和RDB，Redis重启时会使用AOF文件重建数据集，因为AOF文件包含的数据更完整。

### AOF 重写
AOF 重写是指 Redis会在后台以最短的命令序列重建当前的数据集，如对一个key增加1进行了100次加一，会将AOF日志里对应的100个记录合并成一个记录。有两种方式：

- ```REWRITE```：在主线程重写 AOF，会阻塞工作线程，很少用。
- ```BGREWRITE```：后台（子进程）重写 AOF，不影响服务，最常用。

重写流程：

- 一：fork 一个子进程，进行数据重写，同样需要**阻塞**。(确保步骤一、二之间不能穿插新来的写命令，不然会导致新的AOF文件漏掉这些命令)
- 二：重写期间收到的命令既要照常处理，也会缓存一份在新开辟的”重写缓存“里。
- 三：重写完成后，将重写缓存里的数据写入新 AOF 文件，这个过程**阻塞**工作线程，可能会导致超时，主从重连，重新同步等问题。

### 备份和故障恢复
备份

- 用定时任务每小时快照保存RDB文件到同一个文件夹，每天保存的快照都分开不同的文件夹存放。
- 每次运行定时任务，使用```find```命令确保太老的数据快照被删除了，并且文件名要包含日期和时间信息。
- 至少每天一次把RDB快照上传到你的数据中心或者Redis实例所在的物理机。
