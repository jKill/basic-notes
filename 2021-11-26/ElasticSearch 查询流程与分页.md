## ElasticSearch 查询流程与分页
### 查询流程

- 解析请求，分析语法。
- 获取要访问的 Shard 列表。
- 遍历列表，在每个 Shard 上查询数据。（ES 分区存储数据，查询时需要在所有 Shard 中查询）。
- 数据合并，排序。并返回客户端。

### 分页方式

- From + Size 查询
- Search After 查询
- Scroll 查询

#### From + Size 查询
功能上类似于 MySQL 的```limit```，因此同样存在深度翻页问题。适用于总页数不多的场景。

优点

- 支持随机翻页

缺点

- 受限于```max_result_window```（默认10000）不能无限制翻页。
- 深度翻页问题，往后翻页很慢。

#### ```search_after```查询
使用前一页的排序值检索下一页，适用于手机端这类只需要翻下一页的场景。

优点

- 可以无限制往后翻页，总页数不受```max_result_window```限制。

缺点

- 只能向后翻页，不支持随机翻页。

#### Scroll 查询
默认包含了```search_after```的 PIT（Point in time）功能（快照）。查询时只读取快照，对文档的更新（写入、更新或修改）只会影响的查询。因此查询是非实时的，响应时间比 From + Size 和 ```search_after``` 长很多。适合需要遍历全量数据的场景。

优点

- 支持全量遍历。

缺点：

- 查询非实时。
- 保留上下文需要足够的堆空间。
