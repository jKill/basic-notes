## MySQL 读写分离
### 使用场景
数据库读操作比写操作快很多，读写分离能有效提高数据库吞吐量。

- 适用于读比写多的场景，缓解X锁和S锁的竞争。比如：select 很多时，对同一行数据进行 update 和 delete 会被 select 上的锁阻塞。
- 数据冗余，提高可用性。一台数据库服务器挂掉之后，另一个节点还可以继续提供服务

### 主从数据同步

- 从库的 IO 线程把主库的 binlog 拷贝到本地，写入中继日志。然后 SQL 线程会把 binlog 里的 SQL 重新执行一遍。
- 但是执行过程中从库是串行执行的，有时候刚写入主库的数据看不到。

### 半同步复制（semi-sync）

- 主库写入 binlog 后，把binlog 传给从库。
- 从库把 binlog 写入中继日志之后，向主库响应ACK，主库才向客户端返回操作成功。

### 数据迁移

- 停机迁移：简单安全，但是影响业务。
- 双写迁移：新库和老库同时写入，写入完成后检验数据，并逐步把流量切换到新库。
- 使用 DataBus、Canal 等工具：模拟 mysql slave 协议，把自己模拟成 slave。接收来自 master 的 biglog。好处是不用自己实现双写，编写双写代码了。但是依然要在迁移过程中记录日志，防止遗漏数据；迁移完后也依然需要脚本校验新旧数据是否一致；之后也依然需要通过双读等灰度手段，逐步把流量切到新库。

双读：灰度切换读流量，开始只切换少部分流量到新库，遇到问题及时把流量切回老库。对于”双写“阶段（通过开启双写的时间点判断）产生的部分数据，由于是异步写入新库，需要在新库查不到时取老库查。